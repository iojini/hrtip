"""
MalwareBazaar collector - fetches recent malware hashes
https://bazaar.abuse.ch/
Uses public CSV export (no API key required)
"""

import requests
import csv
from datetime import datetime, timezone


def clean(val):
    """Remove spaces and quotes from values"""
    return val.strip().strip('"').strip()


def collect():
    """Fetch recent malware hashes from MalwareBazaar public feed"""
    
    url = "https://bazaar.abuse.ch/export/csv/recent/"
    
    try:
        response = requests.get(url, timeout=60)
        response.raise_for_status()
        
        results = []
        for line in response.text.split('\n'):
            # Skip comments and empty lines
            if line.startswith('#') or not line.strip():
                continue
            
            # Parse the CSV line
            try:
                reader = csv.reader([line])
                parts = next(reader)
            except:
                continue
            
            if len(parts) < 9:
                continue
            
            # Clean all values (remove extra spaces and quotes)
            first_seen = clean(parts[0])
            sha256 = clean(parts[1])
            md5 = clean(parts[2])
            sha1 = clean(parts[3])
            file_name = clean(parts[5])
            file_type = clean(parts[6])
            signature = clean(parts[8])
            
            # Validate SHA256 length
            if not sha256 or len(sha256) != 64:
                continue
            
            results.append({
                "source": "malwarebazaar",
                "type": "sha256",
                "value": sha256.lower(),
                "md5": md5.lower(),
                "sha1": sha1.lower(),
                "threat_type": "malware",
                "malware": signature if signature != "n/a" else None,
                "file_name": file_name,
                "file_type": file_type,
                "first_seen": first_seen,
                "collected_at": datetime.now(timezone.utc).isoformat()
            })
        
        # Limit to 100
        results = results[:100]
        
        print(f"[MalwareBazaar] Collected {len(results)} malware hashes")
        return results
        
    except requests.RequestException as e:
        print(f"[MalwareBazaar] Error: {e}")
        return []


if __name__ == "__main__":
    iocs = collect()
    for ioc in iocs[:5]:
        print(ioc)
